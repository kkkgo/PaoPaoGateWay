<!doctype html> <html lang=en> <head> <meta charset=UTF-8> <meta name=viewport content="width=device-width,initial-scale=1"> <title>PPsub Config Editor</title> <style>:root{--font-normal:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;--color-background:#f0f2f5;--color-background2:#ffffff;--color-bg-card:#ffffff;--color-bg-sidebar:#ffffff;--color-text:#333333;--color-text-secondary:#666666;--color-separator:#e1e4e8;--color-input-bg:#ffffff;--color-input-border:#ced4da;--color-row-odd:#e9ecef;--btn-bg:#007bff;--bg-near-transparent:rgba(255, 255, 255, 0.5);--shadow-card:0 10px 40px rgba(0, 0, 0, 0.08)}[data-theme=dark]{--color-background:#121212;--color-background2:#2c2c2c;--color-bg-card:#1e1e1e;--color-bg-sidebar:#252526;--color-text:#e0e0e0;--color-text-secondary:#a0a0a0;--color-separator:#3e3e3e;--color-input-bg:#2d2d2d;--color-input-border:#444444;--color-row-odd:#333333;--btn-bg:#2196f3;--bg-near-transparent:rgba(255, 255, 255, 0.05);--shadow-card:0 10px 40px rgba(0, 0, 0, 0.4)}body{font-family:var(--font-normal);background:var(--color-background);margin:0;padding:20px;color:var(--color-text);min-height:100vh;box-sizing:border-box;transition:background .3s,color .3s}*{box-sizing:border-box}.container{max-width:1200px;margin:0 auto;background:var(--color-bg-card);border-radius:16px;box-shadow:var(--shadow-card);overflow:hidden;border:1px solid var(--color-separator)}header{background:var(--color-bg-sidebar);border-bottom:1px solid var(--color-separator);padding:24px 40px;display:flex;justify-content:space-between;align-items:center}.title-container h1{margin:0;font-size:1.8em;font-weight:700}.header-actions{display:flex;gap:15px;align-items:center}button{cursor:pointer;font-family:inherit;transition:all .2s}.btn-icon{background:0 0;border:1px solid var(--color-separator);border-radius:8px;padding:8px;color:var(--color-text);display:flex;align-items:center;justify-content:center}.btn-icon svg{width:20px;height:20px;fill:currentColor}.btn-text{background:0 0;border:1px solid var(--color-separator);border-radius:8px;padding:8px 16px;color:var(--color-text);font-weight:600}.btn-primary{padding:10px 24px;border:none;border-radius:8px;background:var(--btn-bg);color:#fff;font-size:.95em;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,.1)}.btn-success{padding:10px 24px;border:none;border-radius:8px;background:#28a745;color:#fff;font-size:.95em;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,.1)}.content{padding:30px 40px}section{margin-bottom:30px;padding:25px;background:var(--bg-near-transparent);border-radius:12px}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.section-title{margin:0;font-size:1.4em;font-weight:700}.monitor-section{border:1px solid #4db6ac;border-left:5px solid #009688}.monitor-section h2{color:#26a69a}.subs-section{border:1px solid #90caf9;border-left:5px solid #1565c0}.subs-section h2{color:#42a5f5}.nodes-section{border:1px solid #ce93d8;border-left:5px solid #7b1fa2}.nodes-section h2{color:#ab47bc}.rules-section{border:1px solid #ffb74d;border-left:5px solid #e65100}.rules-section h2{color:#ff9800}.item{background:var(--color-bg-card);border-radius:10px;padding:20px;margin-bottom:15px;border:1px solid var(--color-separator);box-shadow:0 2px 5px rgba(0,0,0,.05)}.item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:12px;border-bottom:1px solid var(--color-separator)}.item-number{display:inline-block;width:28px;height:28px;line-height:28px;text-align:center;background:var(--color-row-odd);color:var(--color-text);border-radius:50%;font-weight:700;font-size:.85em}.item-name{margin-left:12px;font-size:1.05em;font-weight:600}.btn-delete{padding:6px 14px;border-radius:6px;background:0 0;color:#ff4d4f;border:1px solid #ff4d4f;font-size:.85em;font-weight:600}.item-row{display:flex;align-items:flex-start;gap:15px;margin-bottom:15px;flex-wrap:wrap}.label{min-width:140px;font-weight:600;color:var(--color-text-secondary);padding-top:10px;font-size:.95em}input[type=number],input[type=text],select{flex:1;padding:10px 14px;border:1px solid var(--color-input-border);border-radius:8px;font-size:.95em;background:var(--color-input-bg);color:var(--color-text);outline:0;transition:border-color .2s}input:focus,select:focus,textarea:focus{border-color:var(--btn-bg)}textarea{width:100%;padding:12px 16px;border:1px solid var(--color-input-border);border-radius:8px;font-family:inherit;font-size:.9em;min-height:200px;resize:vertical;line-height:1.6;background:var(--color-input-bg);color:var(--color-text);outline:0}.checkbox-row{display:flex;flex-direction:column;gap:8px;margin-bottom:15px}.checkbox-label{display:flex;align-items:center;gap:8px;cursor:pointer}.checkbox-desc{font-size:.85em;color:var(--color-text-secondary);margin-left:26px}.radio-group{display:flex;gap:20px;flex:1;padding-top:10px;flex-wrap:wrap}.radio-label{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:.95em;background:var(--color-input-bg);padding:8px 12px;border-radius:6px;border:1px solid var(--color-input-border)}.keyword-container{flex:1;display:flex;flex-wrap:wrap;gap:8px;align-items:center}.keyword-tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;color:#fff;font-size:.9em;font-weight:600;box-shadow:0 1px 3px rgba(0,0,0,.2)}.tag-remove{cursor:pointer;font-weight:700;opacity:.8;display:flex;align-items:center}.tag-remove svg{width:12px;height:12px;fill:currentColor}.btn-add-tag{padding:6px 14px;border:1px dashed var(--color-text-secondary);border-radius:20px;background:0 0;color:var(--color-text-secondary);font-size:.9em;font-weight:600}.btn-add-dashed{width:100%;padding:12px;border:1px dashed;border-radius:8px;background:var(--color-background2);font-size:1em;font-weight:600;transition:all .2s}.rule-hint{margin-top:10px;padding:12px 16px;background:var(--bg-near-transparent);border:1px solid #ffc107;border-radius:8px;font-size:.85em;line-height:1.6}.rule-hint a{color:var(--btn-bg)}.footer{background:var(--color-bg-sidebar);border-top:1px solid var(--color-separator);padding:20px;text-align:center;color:var(--color-text-secondary);font-size:.9em}.footer a{color:var(--btn-bg);text-decoration:none;font-weight:600}.overlay{position:fixed;top:0;left:0;right:0;bottom:0;z-index:10001;background:rgba(0,0,0,.4);backdrop-filter:blur(2px)}.popup{position:fixed;background:var(--color-bg-card);border-radius:10px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:10002;border:1px solid var(--color-separator)}.subs-item{padding:10px 14px;cursor:pointer;border-radius:6px;font-size:.95em;display:flex;align-items:center;gap:8px}.subs-item:hover{background:var(--color-row-odd)}.hidden{display:none!important}.priority-badge{padding:4px 10px;border-radius:4px;color:#fff;font-size:.85em;font-weight:700}.btn-nav{padding:6px 12px;border:1px solid var(--color-separator);border-radius:6px;background:var(--color-background2);color:var(--color-text);font-size:.85em;font-weight:600;display:flex;align-items:center;gap:4px}.btn-nav:disabled{opacity:.3;cursor:not-allowed}.btn-nav svg{width:12px;height:12px;fill:currentColor}</style> </head> <body> <div class=container> <header> <div class=title-container> <h1 id=app-title></h1> </div> <div class=header-actions> <button id=lang-btn class=btn-text></button> <button id=theme-btn class=btn-icon> <svg id=icon-sun class=hidden viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000 1.41.996.996 0 001.41 0l1.06-1.06c.39-.39.39-1.03 0-1.41s-1.03-.39-1.41 0l-1.06 1.06z"></path></svg> <svg id=icon-moon viewBox="0 0 24 24"><path d="M9.37 5.51A7.35 7.35 0 009.1 7.5c0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27A7.014 7.014 0 0112 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49zM12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-5.5-5.38c0-1.56.64-3.03 1.75-4.08A8.965 8.965 0 0012 3z"></path></svg> </button> <button id=export-btn class=btn-success></button> <button id=import-btn class=btn-primary></button> <input type=file id=file-input accept=.json style=display:none> </div> </header> <div class=content id=app-content></div> <footer class=footer> © PaoPaoGateWay | <a href=https://github.com/kkkgo/PaoPaoGateWay target=_blank>GitHub</a> </footer> </div> <div id=popup-overlay class="overlay hidden"></div> <div id=delete-popup class="popup hidden" style=display:flex;gap:10px> <button id=confirm-delete class=btn-delete style=background:#dc3545;color:#fff;border:none>Confirm</button> <button id=cancel-delete style="padding:8px 18px;border:1px solid #ccc;border-radius:6px;background:var(--color-background);color:var(--color-text)">Cancel</button> </div> <div id=subs-popup class="popup hidden" style=max-height:300px;overflow-y:auto;min-width:200px;padding:8px></div> <script>const state={monitor:{enable:!1,url:"",retries:3,expectedStatus:"0",customStatus:""},subs:[],nodeGroups:[],rules:[],ui:{deleteConfirm:null,subsSelector:null,inputFocus:null}};let currentLang="en",currentTheme="light";const svgs={star:'<svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>',check:'<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',close:'<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',up:'<svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>',down:'<svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>'},texts={title:{zh:"PPsub配置编辑器",en:"PPsub Config Editor"},exportJson:{zh:"导出配置",en:"Export JSON"},importJson:{zh:"导入配置",en:"Import JSON"},monitorTitle:{zh:"全局健康监测",en:"Global Health Monitor"},enableMonitor:{zh:"开启全局健康监测",en:"Enable Global Health Monitor"},monitorUrl:{zh:"监测URL",en:"Check URL"},monitorUrlDesc:{zh:"若为空，默认为 https://www.youtube.com/generate_204",en:"Default: https://www.youtube.com/generate_204 if empty"},monitorRetries:{zh:"失败重载阈值 (次)",en:"Failure Threshold (Times)"},monitorRetriesDesc:{zh:"当连续监测失败达到此次数后，重载所有配置。",en:"Reload all configs after consecutive failures."},monitorStatus:{zh:"期望返回码",en:"Expected Status"},monitorStatusAny:{zh:"任意 (Any)",en:"Any"},monitorStatusCustom:{zh:"自定义",en:"Custom"},monitorCustomPlaceholder:{zh:"输入状态码 (如 200) 或范围 (如 200-399)",en:"Code (e.g. 200) or Range (e.g. 200-399)"},subsTitle:{zh:"订阅提供商",en:"Subscription Providers"},addSub:{zh:"添加订阅提供商",en:"Add Provider"},nodeGroupsTitle:{zh:"节点组",en:"Node Groups"},addNodeGroup:{zh:"添加节点组",en:"Add Node Group"},ruleSetsTitle:{zh:"规则组",en:"Rule Group"},addRuleSet:{zh:"添加规则组",en:"Add Rule"},name:{zh:"名称",en:"Name"},url:{zh:"URL",en:"URL"},forcedDep:{zh:"强制依赖",en:"Forced Dependency"},forcedDepDesc:{zh:"如果有强制依赖的属性，下载失败则视为处理失败。",en:"If set, download failure treats as process failure."},deleteSub:{zh:"删除此订阅提供商",en:"Delete Provider"},deleteNodeGroup:{zh:"删除此节点组",en:"Delete Node Group"},deleteRuleSet:{zh:"删除此规则组",en:"Delete Rule Set"},nodeGroupName:{zh:"节点组名称",en:"Node Group Name"},nodeMode:{zh:"节点模式",en:"Node Mode"},speedtestMode:{zh:"测速模式",en:"Speedtest Mode"},manualMode:{zh:"手动选择模式",en:"Manual Selection Mode"},speedtestUrl:{zh:"测速URL",en:"Speedtest URL"},speedtestInterval:{zh:"测速间隔",en:"Speedtest Interval"},keywords:{zh:"节点关键字",en:"Node Keywords"},excludeKeywords:{zh:"排除关键字",en:"Exclude Keywords"},subsProvider:{zh:"订阅提供商",en:"Subscription Providers"},addKeyword:{zh:"添加关键字",en:"Add Keyword"},addExcludeKeyword:{zh:"添加排除关键字",en:"Add Exclude Keyword"},selectSub:{zh:"选择订阅",en:"Select Subscription"},all:{zh:"全部",en:"All"},ruleType:{zh:"规则类型",en:"Rule Type"},manualRule:{zh:"手写规则",en:"Manual Rule"},urlDownload:{zh:"URL下载",en:"URL Download"},ruleSetType:{zh:"RULE-SET订阅",en:"RULE-SET Sub"},ruleUrl:{zh:"规则URL",en:"Rule URL"},ruleContent:{zh:"规则内容",en:"Rule Content"},moveUp:{zh:"上移",en:"Move Up"},moveDown:{zh:"下移",en:"Move Down"},addRemark:{zh:"点击添加备注...",en:"Click to add remark..."},topPriority:{zh:"最优先",en:"Top Priority"},highPriority:{zh:"次优先",en:"High Priority"},lastPriority:{zh:"最后",en:"Last"},priority:{zh:"优先级",en:"Priority"},confirm:{zh:"确认删除",en:"Confirm Delete"},cancel:{zh:"取消",en:"Cancel"},emptyState:{zh:"暂无数据，点击下方按钮添加",en:"No data yet, click button below to add"},importFailed:{zh:"导入失败",en:"Import failed"},intervalPlaceholder:{zh:"留空默认为600秒",en:"Default 600s if empty"},behavior:{zh:"行为(Behavior)",en:"Behavior"},ruleSetInterval:{zh:"更新间隔(秒)",en:"Interval (s)"},unnamedSub:{zh:"未命名订阅提供商",en:"Unnamed Provider"},unnamedGroup:{zh:"未命名节点组",en:"Unnamed Node Group"},inputKw:{zh:"输入关键字",en:"Enter keyword"},inputExKw:{zh:"输入排除关键字",en:"Enter exclude keyword"},noSubWarn:{zh:"请先添加订阅提供商",en:"Add providers first"}},t=e=>texts[e][currentLang],keywordColors=["#ff6b35","#f7931e","#ffc107","#28a745","#17a2b8","#6610f2","#e83e8c"];function init(){const e=navigator.language||navigator.userLanguage;currentLang=e.startsWith("zh")?"zh":"en",window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?setTheme("dark"):setTheme("light"),document.getElementById("lang-btn").onclick=toggleLang,document.getElementById("theme-btn").onclick=toggleTheme,document.getElementById("export-btn").onclick=handleExport,document.getElementById("import-btn").onclick=()=>document.getElementById("file-input").click(),document.getElementById("file-input").onchange=handleImport,document.getElementById("popup-overlay").onclick=closePopups,document.getElementById("confirm-delete").onclick=confirmDelete,document.getElementById("cancel-delete").onclick=closePopups,renderAll()}function toggleLang(){currentLang="zh"===currentLang?"en":"zh",renderAll()}function toggleTheme(){setTheme("light"===currentTheme?"dark":"light")}function setTheme(e){currentTheme=e,document.documentElement.setAttribute("data-theme",e),"dark"===e?(document.getElementById("icon-sun").classList.remove("hidden"),document.getElementById("icon-moon").classList.add("hidden")):(document.getElementById("icon-sun").classList.add("hidden"),document.getElementById("icon-moon").classList.remove("hidden"))}function renderAll(){document.getElementById("app-title").textContent=t("title"),document.getElementById("lang-btn").textContent="zh"===currentLang?"English":"中文",document.getElementById("export-btn").textContent=t("exportJson"),document.getElementById("import-btn").textContent=t("importJson"),document.getElementById("confirm-delete").textContent=t("confirm"),document.getElementById("cancel-delete").textContent=t("cancel");if(document.getElementById("app-content").innerHTML=`\n                ${renderMonitor()}\n                ${renderSubs()}\n                ${renderNodeGroups()}\n                ${renderRules()}\n            `,bindEvents(),state.ui.inputFocus){const e=document.getElementById(state.ui.inputFocus);if(e&&(e.focus(),e.value)){const t=e.value.length;e.setSelectionRange(t,t)}}}function renderMonitor(){const e=state.monitor;return e.enable?`\n            <section class="monitor-section">\n                <div class="section-header"><h2 class="section-title">${t("monitorTitle")}</h2></div>\n                <div class="checkbox-row">\n                    <label class="checkbox-label">\n                        <input type="checkbox" checked onchange="updateMonitor('enable', this.checked)">\n                        <span>${t("enableMonitor")}</span>\n                    </label>\n                </div>\n                <div class="item-row">\n                    <label class="label">${t("monitorUrl")}:</label>\n                    <input type="text" value="${esc(e.url)}" oninput="updateMonitor('url', this.value)" placeholder="https://www.youtube.com/generate_204" id="mon-url">\n                    <span style="font-size:0.85em;color:var(--color-text-secondary);align-self:center;">${t("monitorUrlDesc")}</span>\n                </div>\n                <div class="item-row">\n                    <label class="label">${t("monitorStatus")}:</label>\n                    <select onchange="updateMonitor('expectedStatus', this.value)" style="max-width:200px">\n                        <option value="0" ${"0"===e.expectedStatus?"selected":""}>${t("monitorStatusAny")}</option>\n                        <option value="200" ${"200"===e.expectedStatus?"selected":""}>200</option>\n                        <option value="204" ${"204"===e.expectedStatus?"selected":""}>204</option>\n                        <option value="200-399" ${"200-399"===e.expectedStatus?"selected":""}>200-399</option>\n                        <option value="custom" ${"custom"===e.expectedStatus?"selected":""}>${t("monitorStatusCustom")}</option>\n                    </select>\n                    ${"custom"===e.expectedStatus?`<input type="text" value="${esc(e.customStatus)}" oninput="updateMonitor('customStatus', this.value)" placeholder="${t("monitorCustomPlaceholder")}" id="mon-cust">`:""}\n                </div>\n                <div class="item-row">\n                    <label class="label">${t("monitorRetries")}:</label>\n                    <input type="number" value="${e.retries}" oninput="updateMonitor('retries', parseInt(this.value))" style="max-width:150px" min="1" id="mon-retry">\n                    <span style="font-size:0.85em;color:var(--color-text-secondary);align-self:center;">${t("monitorRetriesDesc")}</span>\n                </div>\n            </section>`:`\n                <section class="monitor-section">\n                    <div class="section-header"><h2 class="section-title">${t("monitorTitle")}</h2></div>\n                    <div class="checkbox-row">\n                        <label class="checkbox-label">\n                            <input type="checkbox" onchange="updateMonitor('enable', this.checked)">\n                            <span>${t("enableMonitor")}</span>\n                        </label>\n                    </div>\n                </section>`}function renderSubs(){let e=0===state.subs.length?`<div style="text-align:center;color:gray;padding:20px;">${t("emptyState")}</div>`:state.subs.map((e,n)=>`\n                <div class="item">\n                    <div class="item-header">\n                        <div style="display:flex;align-items:center;">\n                            <span class="item-number">#${n+1}</span>\n                            <span class="item-name">${esc(e.name)||t("unnamedSub")}</span>\n                        </div>\n                        <button class="btn-delete" onclick="askDelete('sub', ${n}, event)">${t("deleteSub")}</button>\n                    </div>\n                    <div class="item-row">\n                        <label class="label">${t("name")}:</label>\n                        <input type="text" value="${esc(e.name)}" oninput="updateSub(${n}, 'name', this.value)" placeholder="e.g. My Provider" id="sub-name-${n}">\n                    </div>\n                    <div class="item-row">\n                        <label class="label">${t("url")}:</label>\n                        <input type="text" value="${esc(e.url)}" oninput="updateSub(${n}, 'url', this.value)" placeholder="Subscription URL" id="sub-url-${n}">\n                    </div>\n                    <div class="checkbox-row">\n                        <label class="checkbox-label">\n                            <input type="checkbox" ${e.isforced?"checked":""} onchange="updateSub(${n}, 'isforced', this.checked)">\n                            <span>${t("forcedDep")}</span>\n                        </label>\n                        <span class="checkbox-desc">${t("forcedDepDesc")}</span>\n                    </div>\n                </div>`).join("");return`\n            <section class="subs-section">\n                <div class="section-header"><h2 class="section-title">${t("subsTitle")}</h2></div>\n                ${e}\n                <div style="margin-top:15px;display:flex;justify-content:center;">\n                    <button class="btn-add-dashed" style="color:#42a5f5;border-color:#90caf9;" onclick="addSub()">+ ${t("addSub")}</button>\n                </div>\n            </section>`}function renderNodeGroups(){let e=0===state.nodeGroups.length?`<div style="text-align:center;color:gray;padding:20px;">${t("emptyState")}</div>`:state.nodeGroups.map((e,n)=>{const l=e.keywords.map((e,t)=>"object"==typeof e?`<input type="text" class="keyword-input" style="width:100px;border-radius:20px;padding:4px 10px;" value="${e.value}" id="nk-${n}-${t}" onblur="commitKeyword(${n}, 'keywords', ${t})" onkeypress="if(event.key==='Enter') this.blur()">`:`<span class="keyword-tag" style="background:${keywordColors[t%keywordColors.length]}">${esc(e)} <span class="tag-remove" onclick="removeKeyword(${n}, 'keywords', ${t})">${svgs.close}</span></span>`).join(""),s=e.exclude_keywords.map((e,t)=>"object"==typeof e?`<input type="text" class="keyword-input" style="width:100px;border-radius:20px;padding:4px 10px;" value="${e.value}" id="ek-${n}-${t}" onblur="commitKeyword(${n}, 'exclude_keywords', ${t})" onkeypress="if(event.key==='Enter') this.blur()">`:`<span class="keyword-tag" style="background:${keywordColors[(t+3)%keywordColors.length]}">${esc(e)} <span class="tag-remove" onclick="removeKeyword(${n}, 'exclude_keywords', ${t})">${svgs.close}</span></span>`).join(""),o=e.subs.map((e,l)=>`\n                        <span class="keyword-tag" style="background:${"all"===e?"#6c757d":"#17a2b8"}">\n                            ${"all"===e?'<span style="width:14px;fill:white;margin-right:4px">'+svgs.star+"</span>":""}${"all"===e?t("all"):esc(e)}\n                            <span class="tag-remove" onclick="removeGroupSub(${n}, ${l})">${svgs.close}</span>\n                        </span>\n                    `).join("");return`\n                    <div class="item">\n                        <div class="item-header">\n                            <div style="display:flex;align-items:center;">\n                                <span class="item-number">#${n+1}</span>\n                                <span class="item-name">${esc(e.name)||t("unnamedGroup")}</span>\n                            </div>\n                            <button class="btn-delete" onclick="askDelete('nodeGroup', ${n}, event)">${t("deleteNodeGroup")}</button>\n                        </div>\n                        <div class="item-row">\n                            <label class="label">${t("nodeGroupName")}:</label>\n                            <input type="text" value="${esc(e.name)}" oninput="updateNodeGroup(${n}, 'name', this.value)" id="ng-name-${n}">\n                        </div>\n                        <div class="item-row">\n                            <label class="label">${t("nodeMode")}:</label>\n                            <div class="radio-group">\n                                <label class="radio-label">\n                                    <input type="radio" name="mode-${n}" ${"speedtest"===e.mode?"checked":""} onchange="updateNodeGroup(${n}, 'mode', 'speedtest')">\n                                    <span>${t("speedtestMode")}</span>\n                                </label>\n                                <label class="radio-label">\n                                    <input type="radio" name="mode-${n}" ${"manual"===e.mode?"checked":""} onchange="updateNodeGroup(${n}, 'mode', 'manual')">\n                                    <span>${t("manualMode")}</span>\n                                </label>\n                            </div>\n                        </div>\n                        ${"speedtest"===e.mode?`\n                        <div class="item-row">\n                            <label class="label">${t("speedtestUrl")}:</label>\n                            <input type="text" value="${esc(e.speedtest_url||"")}" oninput="updateNodeGroup(${n}, 'speedtest_url', this.value)" id="ng-sp-${n}">\n                        </div>\n                        <div class="item-row">\n                            <label class="label">${t("speedtestInterval")}:</label>\n                            <input type="text" value="${esc(e.interval||"")}" oninput="updateNodeGroup(${n}, 'interval', this.value)" placeholder="${t("intervalPlaceholder")}" id="ng-int-${n}">\n                        </div>`:""}\n                        <div class="item-row">\n                            <label class="label">${t("keywords")}:</label>\n                            <div class="keyword-container">\n                                ${l}\n                                ${e.keywords.some(e=>"object"==typeof e)?"":`<button class="btn-add-tag" onclick="addKeywordPlaceholder(${n}, 'keywords')">+ ${t("addKeyword")}</button>`}\n                            </div>\n                        </div>\n                        <div class="item-row">\n                            <label class="label">${t("excludeKeywords")}:</label>\n                            <div class="keyword-container">\n                                ${s}\n                                ${e.exclude_keywords.some(e=>"object"==typeof e)?"":`<button class="btn-add-tag" onclick="addKeywordPlaceholder(${n}, 'exclude_keywords')">+ ${t("addExcludeKeyword")}</button>`}\n                            </div>\n                        </div>\n                        <div class="item-row">\n                            <label class="label">${t("subsProvider")}:</label>\n                            <div class="keyword-container">\n                                ${o}\n                                <button class="btn-add-tag" onclick="openSubsSelector(${n}, event)">+ ${t("selectSub")}</button>\n                            </div>\n                        </div>\n                    </div>`}).join("");return`\n            <section class="nodes-section">\n                <div class="section-header"><h2 class="section-title">${t("nodeGroupsTitle")}</h2></div>\n                ${e}\n                <div style="margin-top:15px;display:flex;justify-content:center;">\n                    <button class="btn-add-dashed" style="color:#ab47bc;border-color:#ce93d8;" onclick="addNodeGroup()">+ ${t("addNodeGroup")}</button>\n                </div>\n            </section>`}function renderRules(){let e=0===state.rules.length?`<div style="text-align:center;color:gray;padding:20px;">${t("emptyState")}</div>`:state.rules.map((e,n)=>{const l=state.rules.length;let s="#17a2b8",o=`${t("priority")} ${e.priority}`;return 1===e.priority?(s="#ff6b35",o=t("topPriority")):2===e.priority?(s="#f7931e",o=t("highPriority")):e.priority===l&&(s="#6c757d",o=t("lastPriority")),`\n                    <div class="item">\n                        <div class="item-header">\n                            <div style="display:flex;align-items:center;gap:12px;">\n                                <span class="item-number">#${n+1}</span>\n                                <span class="priority-badge" style="background:${s}">${o}</span>\n                                <input type="text" value="${esc(e.remark)}" oninput="updateRule(${n}, 'remark', this.value)" placeholder="${t("addRemark")}" style="border:none;border-bottom:1px dashed #ccc;padding:2px;background:transparent;width:150px;" id="rule-rem-${n}">\n                            </div>\n                            <div style="display:flex;gap:10px;">\n                                <button class="btn-nav" onclick="moveRule(${n}, -1)" ${0===n?"disabled":""}>${svgs.up} ${t("moveUp")}</button>\n                                <button class="btn-nav" onclick="moveRule(${n}, 1)" ${n===l-1?"disabled":""}>${svgs.down} ${t("moveDown")}</button>\n                                <button class="btn-delete" onclick="askDelete('ruleSet', ${n}, event)">${t("deleteRuleSet")}</button>\n                            </div>\n                        </div>\n                        <div class="item-row">\n                            <label class="label">${t("ruleType")}:</label>\n                            <div class="radio-group">\n                                <label class="radio-label"><input type="radio" name="rtype-${n}" ${"manual"===e.type?"checked":""} onchange="updateRule(${n}, 'type', 'manual')"> ${t("manualRule")}</label>\n                                <label class="radio-label"><input type="radio" name="rtype-${n}" ${"url"===e.type?"checked":""} onchange="updateRule(${n}, 'type', 'url')"> ${t("urlDownload")}</label>\n                                <label class="radio-label"><input type="radio" name="rtype-${n}" ${"rule-set"===e.type?"checked":""} onchange="updateRule(${n}, 'type', 'rule-set')"> ${t("ruleSetType")}</label>\n                            </div>\n                        </div>\n                        ${"rule-set"===e.type?`\n                             <div class="item-row"><label class="label">${t("name")}:</label><input type="text" value="${esc(e.name||"")}" oninput="updateRule(${n}, 'name', this.value)" placeholder="e.g. openai" id="rs-name-${n}"></div>\n                             <div class="item-row"><label class="label">${t("ruleUrl")}:</label><input type="text" value="${esc(e.url)}" oninput="updateRule(${n}, 'url', this.value)" id="rs-url-${n}"></div>\n                             <div class="item-row"><label class="label">${t("behavior")}:</label>\n                                <select onchange="updateRule(${n}, 'behavior', this.value)">\n                                    <option value="classical" ${"classical"===e.behavior?"selected":""}>classical</option>\n                                    <option value="domain" ${"domain"===e.behavior?"selected":""}>domain</option>\n                                    <option value="ipcidr" ${"ipcidr"===e.behavior?"selected":""}>ipcidr</option>\n                                </select>\n                             </div>\n                             <div class="item-row"><label class="label">${t("ruleSetInterval")}:</label><input type="number" value="${e.interval||86400}" oninput="updateRule(${n}, 'interval', parseInt(this.value))" id="rs-int-${n}"></div>\n                             <div class="rule-hint">RULE-SET Usage: RULE-SET,name,group</div>\n                        `:"url"===e.type?`\n                             <div class="item-row"><label class="label">${t("ruleUrl")}:</label><input type="text" value="${esc(e.url)}" oninput="updateRule(${n}, 'url', this.value)" id="rs-url-${n}"></div>\n                             <div class="checkbox-row"><label class="checkbox-label"><input type="checkbox" ${e.isforced?"checked":""} onchange="updateRule(${n}, 'isforced', this.checked)"> <span>${t("forcedDep")}</span></label></div>\n                        `:`\n                             <div class="item-row" style="flex-direction:column;align-items:stretch;">\n                                <label class="label">${t("ruleContent")}:</label>\n                                <textarea oninput="updateRule(${n}, 'content', this.value)" id="rs-cont-${n}">${esc(e.content)}</textarea>\n                                <div class="rule-hint">Format: TYPE,MATCH,GROUP (e.g. GEOSITE,openai,AI-Nodes)</div>\n                             </div>\n                        `}\n                    </div>`}).join("");return`\n            <section class="rules-section">\n                <div class="section-header"><h2 class="section-title">${t("ruleSetsTitle")}</h2></div>\n                ${e}\n                <div style="margin-top:15px;display:flex;justify-content:center;">\n                    <button class="btn-add-dashed" style="color:#ff9800;border-color:#ffb74d;" onclick="addRuleSet()">+ ${t("addRuleSet")}</button>\n                </div>\n            </section>`}function esc(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function updateMonitor(e,t){state.monitor[e]=t,"enable"===e||"expectedStatus"===e?renderAll():state.ui.inputFocus="mon-"+("expectedStatus"===e?"cust":"retries"===e?"retry":"url"===e?"url":"cust")}function addSub(){state.subs.push({name:"",url:"",isforced:!1}),renderAll()}function updateSub(e,t,n){state.subs[e][t]=n,state.ui.inputFocus=`sub-${t}-${e}`}function addNodeGroup(){state.nodeGroups.push({name:"",keywords:[],exclude_keywords:[],subs:["all"],mode:"manual"}),renderAll()}function updateNodeGroup(e,t,n){state.nodeGroups[e][t]=n,"mode"===t?renderAll():state.ui.inputFocus=`ng-${"speedtest_url"===t?"sp":"interval"===t?"int":"name"}-${e}`}function addKeywordPlaceholder(e,t){state.nodeGroups[e][t].push({value:"",isNew:!0}),renderAll(),setTimeout(()=>{const n=document.getElementById(`${"keywords"===t?"nk":"ek"}-${e}-${state.nodeGroups[e][t].length-1}`);n&&n.focus()},50)}function commitKeyword(e,t,n){const l=document.getElementById(`${"keywords"===t?"nk":"ek"}-${e}-${n}`).value.trim();l?state.nodeGroups[e][t][n]=l:state.nodeGroups[e][t].splice(n,1),renderAll()}function removeKeyword(e,t,n){state.nodeGroups[e][t].splice(n,1),renderAll()}function removeGroupSub(e,t){const n=state.nodeGroups[e];n.subs.splice(t,1),0===n.subs.length&&(n.subs=["all"]),renderAll()}function addRuleSet(){state.rules.push({priority:state.rules.length+1,remark:"",name:"",type:"manual",url:"",content:"",behavior:"classical",interval:86400}),renderAll()}function updateRule(e,t,n){state.rules[e][t]=n,"type"===t||"behavior"===t?renderAll():state.ui.inputFocus="remark"===t?`rule-rem-${e}`:"content"===t?`rs-cont-${e}`:`rs-${"interval"===t?"int":"name"===t?"name":"url"}-${e}`}function moveRule(e,t){const n=e+t;if(n<0||n>=state.rules.length)return;const l=state.rules[e];state.rules[e]=state.rules[n],state.rules[n]=l,state.rules.forEach((e,t)=>e.priority=t+1),renderAll()}function askDelete(e,t,n){state.ui.deleteConfirm={type:e,index:t};const l=document.getElementById("delete-popup"),s=document.getElementById("popup-overlay");l.style.top=n.clientY+"px",l.style.left=n.clientX+"px",l.classList.remove("hidden"),s.classList.remove("hidden")}function confirmDelete(){const{type:e,index:t}=state.ui.deleteConfirm;"sub"===e?state.subs.splice(t,1):"nodeGroup"===e?state.nodeGroups.splice(t,1):"ruleSet"===e&&(state.rules.splice(t,1),state.rules.forEach((e,t)=>e.priority=t+1)),closePopups(),renderAll()}function openSubsSelector(e,n){const l=document.getElementById("subs-popup"),s=document.getElementById("popup-overlay");let o=`\n                <div class="subs-item" onclick="toggleSubSel(${e}, 'all')">\n                    ${state.nodeGroups[e].subs.includes("all")?'<span style="width:16px">'+svgs.check+"</span>":'<span style="width:16px"></span>'} \n                    <span style="width:16px;fill:orange;margin-right:4px;">${svgs.star}</span> ${t("all")}\n                </div>\n            `;0===state.subs.length?o+=`<div class="subs-item" style="opacity:0.5;cursor:default;">${t("noSubWarn")}</div>`:state.subs.forEach(t=>{if(!t.name)return;const n=state.nodeGroups[e].subs.includes(t.name);o+=`\n                        <div class="subs-item" onclick="toggleSubSel(${e}, '${esc(t.name)}')">\n                            ${n?'<span style="width:16px;fill:green">'+svgs.check+"</span>":'<span style="width:16px"></span>'} \n                            ${esc(t.name)}\n                        </div>\n                    `}),l.innerHTML=o,l.style.top=n.clientY+10+"px",l.style.left=n.clientX+"px",l.classList.remove("hidden"),s.classList.remove("hidden")}function toggleSubSel(e,t){const n=state.nodeGroups[e];if("all"===t)n.subs=["all"];else{n.subs=n.subs.filter(e=>"all"!==e);const e=n.subs.indexOf(t);e>-1?n.subs.splice(e,1):n.subs.push(t),0===n.subs.length&&(n.subs=["all"])}renderAll(),closePopups()}function closePopups(){document.getElementById("delete-popup").classList.add("hidden"),document.getElementById("subs-popup").classList.add("hidden"),document.getElementById("popup-overlay").classList.add("hidden"),state.ui.deleteConfirm=null}function bindEvents(){}function handleExport(){const e=state.monitor;let t="custom"===e.expectedStatus?e.customStatus:e.expectedStatus;const n={version:"1.0",exported_at:(new Date).toISOString(),global_monitor:{enable:e.enable,url:e.url.trim()||"https://www.youtube.com/generate_204",retries:e.retries,expected_status:t},subs:state.subs.map(e=>{let t={name:e.name,url:e.url};return e.isforced&&(t.isforced=!0),t}),"node-groups":state.nodeGroups.map(e=>{let t={name:e.name,keywords:e.keywords.filter(e=>"string"==typeof e),exclude_keywords:e.exclude_keywords.filter(e=>"string"==typeof e),subs:e.subs.length?e.subs:["all"]};return"speedtest"===e.mode&&(e.speedtest_url&&(t.speedtest_url=e.speedtest_url.trim()),t.interval=e.interval?parseInt(e.interval):600),t}),rules:state.rules.map((e,t)=>{let n={priority:10*(t+1)};if(e.remark&&(n.remark=e.remark),"rule-set"===e.type)n.type="rule-set",n.name=e.name||`ruleset_${t}`,n.url=e.url,n.behavior=e.behavior||"classical",n.interval=e.interval||86400;else if("url"===e.type)n.url=e.url,e.isforced&&(n.isforced=!0);else{const t=(e.content||"").split("\n").map(e=>normalizeRule(e)).filter(e=>null!==e);n.fixrule=t}return n})},l=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),s=URL.createObjectURL(l),o=document.createElement("a");o.href=s,o.download="ppsub.json",o.click(),URL.revokeObjectURL(s)}function handleImport(e){const n=e.target.files[0];if(!n)return;const l=new FileReader;l.onload=e=>{try{const t=JSON.parse(e.target.result);if(t.global_monitor){state.monitor.enable=!!t.global_monitor.enable,state.monitor.url=t.global_monitor.url||"",state.monitor.retries=t.global_monitor.retries||3;const e=String(t.global_monitor.expected_status||"0");["0","200","204","200-399"].includes(e)?(state.monitor.expectedStatus=e,state.monitor.customStatus=""):(state.monitor.expectedStatus="custom",state.monitor.customStatus=e)}state.subs=(t.subs||[]).map(e=>({name:e.name||"",url:e.url||"",isforced:!!e.isforced})),state.nodeGroups=(t["node-groups"]||[]).map(e=>({name:e.name||"",keywords:e.keywords||[],exclude_keywords:e.exclude_keywords||[],subs:e.subs||[],mode:e.speedtest_url||e.interval?"speedtest":"manual",speedtest_url:e.speedtest_url||"",interval:e.interval?String(e.interval):""}));const n=t.rules||t["rule-sets"]||[];state.rules=n.map((e,t)=>{let n="manual";"rule-set"===e.type?n="rule-set":e.url&&(n="url");let l="";return"manual"===n&&(Array.isArray(e.fixrule)?l=e.fixrule.join("\n"):e.content&&(l=e.content)),{priority:t+1,remark:e.remark||"",name:e.name||"",type:n,url:e.url||"",content:l,isforced:!!e.isforced,behavior:e.behavior||"classical",interval:e.interval||86400}}),renderAll()}catch(e){alert(t("importFailed")+": "+e)}},l.readAsText(n),e.target.value=""}function normalizeRule(e){const t=(e=e.trim().replace(/^[-\s]+/,"")).indexOf("#");if(-1!==t&&(e=e.substring(0,t).trim()),!e)return null;const n=e.indexOf(",");if(-1===n)return"MATCH"===e.toUpperCase().replace(/[-\s_]/g,"")?"MATCH,auto":null;const l=e.substring(0,n).trim(),s=e.substring(n+1).trim(),o=l.toUpperCase().replace(/[-\s_]/g,""),a={DOMAIN:"DOMAIN",DOMAINSUFFIX:"DOMAIN-SUFFIX",DOMAINKEYWORD:"DOMAIN-KEYWORD",DOMAINWILDCARD:"DOMAIN-WILDCARD",DOMAINREGEX:"DOMAIN-REGEX",GEOSITE:"GEOSITE",IPCIDR:"IP-CIDR",IPCIDR6:"IP-CIDR6",IPSUFFIX:"IP-SUFFIX",IPASN:"IP-ASN",GEOIP:"GEOIP",SRCGEOIP:"SRC-GEOIP",SRCIPASN:"SRC-IP-ASN",SRCIPCIDR:"SRC-IP-CIDR",SRCIPSUFFIX:"SRC-IP-SUFFIX",SRCPORT:"SRC-PORT",DSTPORT:"DST-PORT",NETWORK:"NETWORK",RULESET:"RULE-SET",SUBRULE:"SUB-RULE",AND:"AND",OR:"OR",NOT:"NOT",MATCH:"MATCH"};return a[o]?`${a[o]},${s}`:null}init()</script> </body> </html>