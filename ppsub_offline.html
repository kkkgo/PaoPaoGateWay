<!doctype html> <html lang=en> <head> <meta charset=UTF-8> <meta name=viewport content="width=device-width,initial-scale=1"> <title>PPsub Config Editor</title> <style>:root{--font-normal:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;--color-background:#f0f2f5;--color-background2:#ffffff;--color-bg-card:#ffffff;--color-bg-sidebar:#ffffff;--color-text:#333333;--color-text-secondary:#666666;--color-separator:#e1e4e8;--color-input-bg:#ffffff;--color-input-border:#ced4da;--color-row-odd:#e9ecef;--btn-bg:#007bff;--bg-near-transparent:rgba(255, 255, 255, 0.5);--shadow-card:0 10px 40px rgba(0, 0, 0, 0.08);--color-monitor-border:#4db6ac;--color-monitor-accent:#009688;--color-subs-border:#90caf9;--color-subs-accent:#1565c0;--color-nodes-border:#ce93d8;--color-nodes-accent:#7b1fa2;--color-rules-border:#ffb74d;--color-rules-accent:#e65100}[data-theme=dark]{--color-background:#121212;--color-background2:#2c2c2c;--color-bg-card:#1e1e1e;--color-bg-sidebar:#252526;--color-text:#e0e0e0;--color-text-secondary:#a0a0a0;--color-separator:#3e3e3e;--color-input-bg:#2d2d2d;--color-input-border:#444444;--color-row-odd:#333333;--btn-bg:#2196f3;--bg-near-transparent:rgba(255, 255, 255, 0.05);--shadow-card:0 10px 40px rgba(0, 0, 0, 0.4);--color-monitor-border:#00695c;--color-monitor-accent:#80cbc4;--color-subs-border:#0d47a1;--color-subs-accent:#90caf9;--color-nodes-border:#6a1b9a;--color-nodes-accent:#ce93d8;--color-rules-border:#e65100;--color-rules-accent:#ffb74d}body{font-family:var(--font-normal);background:var(--color-background);margin:0;padding:20px;color:var(--color-text);min-height:100vh;box-sizing:border-box;transition:background .3s,color .3s}*{box-sizing:border-box}.container{max-width:1200px;margin:0 auto;background:var(--color-bg-card);border-radius:16px;box-shadow:var(--shadow-card);overflow:hidden;border:1px solid var(--color-separator)}header{background:var(--color-bg-sidebar);border-bottom:1px solid var(--color-separator);padding:24px 40px;display:flex;justify-content:space-between;align-items:center}.title-container h1{margin:0;font-size:1.8em;font-weight:700}.header-actions{display:flex;gap:15px;align-items:center}button{cursor:pointer;font-family:inherit;transition:all .2s}.btn-icon{background:0 0;border:1px solid var(--color-separator);border-radius:8px;padding:8px;color:var(--color-text);display:flex;align-items:center;justify-content:center}.btn-icon svg{width:20px;height:20px;fill:currentColor}.btn-text{background:0 0;border:1px solid var(--color-separator);border-radius:8px;padding:8px 16px;color:var(--color-text);font-weight:600}.btn-primary{padding:10px 24px;border:none;border-radius:8px;background:var(--btn-bg);color:#fff;font-size:.95em;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,.1)}.btn-success{padding:10px 24px;border:none;border-radius:8px;background:#28a745;color:#fff;font-size:.95em;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,.1)}.content{padding:30px 40px}section{margin-bottom:30px;padding:25px;background:var(--bg-near-transparent);border-radius:12px}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.section-title{margin:0;font-size:1.4em;font-weight:700}.monitor-section{border:1px solid var(--color-monitor-border);border-left:5px solid var(--color-monitor-accent)}.monitor-section h2{color:var(--color-monitor-accent)}.subs-section{border:1px solid var(--color-subs-border);border-left:5px solid var(--color-subs-accent)}.subs-section h2{color:var(--color-subs-accent)}.nodes-section{border:1px solid var(--color-nodes-border);border-left:5px solid var(--color-nodes-accent)}.nodes-section h2{color:var(--color-nodes-accent)}.rules-section{border:1px solid var(--color-rules-border);border-left:5px solid var(--color-rules-accent)}.rules-section h2{color:var(--color-rules-accent)}.item{background:var(--color-bg-card);border-radius:10px;padding:20px;margin-bottom:15px;border:1px solid var(--color-separator);box-shadow:0 2px 5px rgba(0,0,0,.05)}.item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:12px;border-bottom:1px solid var(--color-separator)}.item-number{display:inline-block;width:28px;height:28px;line-height:28px;text-align:center;background:var(--color-row-odd);color:var(--color-text);border-radius:50%;font-weight:700;font-size:.85em}.item-name{margin-left:12px;font-size:1.05em;font-weight:600}.btn-delete{padding:6px 14px;border-radius:6px;background:0 0;color:#ff4d4f;border:1px solid #ff4d4f;font-size:.85em;font-weight:600}.btn-copy{padding:6px 14px;border-radius:6px;background:0 0;color:#17a2b8;border:1px solid #17a2b8;font-size:.85em;font-weight:600}.item-row{display:flex;align-items:flex-start;gap:15px;margin-bottom:15px;flex-wrap:wrap}.label{min-width:140px;font-weight:600;color:var(--color-text-secondary);padding-top:10px;font-size:.95em}input[type=number],input[type=text],select{flex:1;padding:10px 14px;border:1px solid var(--color-input-border);border-radius:8px;font-size:.95em;background:var(--color-input-bg);color:var(--color-text);outline:0;transition:border-color .2s}input:focus,select:focus,textarea:focus{border-color:var(--btn-bg)}textarea{width:100%;padding:12px 16px;border:1px solid var(--color-input-border);border-radius:8px;font-family:inherit;font-size:.9em;min-height:200px;resize:vertical;line-height:1.6;background:var(--color-input-bg);color:var(--color-text);outline:0}.checkbox-row{display:flex;flex-direction:column;gap:8px;margin-bottom:15px}.checkbox-label{display:flex;align-items:center;gap:8px;cursor:pointer}.checkbox-desc{font-size:.85em;color:var(--color-text-secondary);margin-left:26px}.radio-group{display:flex;gap:20px;flex:1;padding-top:10px;flex-wrap:wrap}.radio-label{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:.95em;background:var(--color-input-bg);padding:8px 12px;border-radius:6px;border:1px solid var(--color-input-border)}.keyword-container{flex:1;display:flex;flex-wrap:wrap;gap:8px;align-items:center}.keyword-tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;color:#fff;font-size:.9em;font-weight:600;box-shadow:0 1px 3px rgba(0,0,0,.2)}.tag-remove{cursor:pointer;font-weight:700;opacity:.8;display:flex;align-items:center}.tag-remove svg{width:12px;height:12px;fill:currentColor}.btn-add-tag{padding:6px 14px;border:1px dashed var(--color-text-secondary);border-radius:20px;background:0 0;color:var(--color-text-secondary);font-size:.9em;font-weight:600}.btn-add-dashed{width:100%;padding:12px;border:1px dashed;border-radius:8px;background:var(--color-background2);font-size:1em;font-weight:600;transition:all .2s}.rule-hint{margin-top:10px;padding:12px 16px;background:var(--bg-near-transparent);border:1px solid #ffc107;border-radius:8px;font-size:.85em;line-height:1.6;color:var(--color-text)}.rule-hint a{color:var(--btn-bg)}.footer{background:var(--color-bg-sidebar);border-top:1px solid var(--color-separator);padding:20px;text-align:center;color:var(--color-text-secondary);font-size:.9em}.footer a{color:var(--btn-bg);text-decoration:none;font-weight:600}.overlay{position:fixed;top:0;left:0;right:0;bottom:0;z-index:10001;background:rgba(0,0,0,.4);backdrop-filter:blur(2px)}.popup{position:fixed;background:var(--color-bg-card);border-radius:10px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:10002;border:1px solid var(--color-separator)}.subs-item{padding:10px 14px;cursor:pointer;border-radius:6px;font-size:.95em;display:flex;align-items:center;gap:8px;color:var(--color-text)}.subs-item:hover{background:var(--color-row-odd)}.hidden{display:none!important}.priority-badge{padding:4px 10px;border-radius:4px;color:#fff;font-size:.85em;font-weight:700}.btn-nav{padding:6px 12px;border:1px solid var(--color-separator);border-radius:6px;background:var(--color-background2);color:var(--color-text);font-size:.85em;font-weight:600;display:flex;align-items:center;gap:4px}.btn-nav:disabled{opacity:.3;cursor:not-allowed}.btn-nav svg{width:12px;height:12px;fill:currentColor}.notification-banner{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:8px;z-index:20000;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,.2);text-align:center;max-width:80%;animation:fadeIn .3s ease-in-out}.notification-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}.notification-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}@keyframes fadeIn{from{opacity:0;transform:translate(-50%,-20px)}to{opacity:1;transform:translate(-50%,0)}}.dropdown-wrapper{position:relative;flex:1}.dropdown-list{position:absolute;top:100%;left:0;right:0;background:var(--color-bg-card);border:1px solid var(--btn-bg);border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.15)}.dropdown-item{padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--color-separator);font-size:.95em;color:var(--color-text)}.dropdown-item:hover{background:var(--color-background2)}.subs-search-input{width:100%;padding:8px;margin-bottom:4px;border:1px solid var(--btn-bg);border-radius:6px;font-size:.9em;background:var(--color-input-bg);color:var(--color-text);outline:0;box-sizing:border-box}.filter-select{width:100%;padding:8px;margin-bottom:8px;border:1px solid var(--btn-bg);border-radius:6px;font-size:.9em;background:var(--color-input-bg);color:var(--color-text);outline:0;cursor:pointer}</style> </head> <body> <div id=notification-area></div> <div class=container> <header> <div class=title-container> <h1 id=app-title></h1> </div> <div class=header-actions><button id=lang-btn class=btn-text></button><button id=theme-btn class=btn-icon><svg id=icon-sun class=hidden viewBox="0 0 24 24"> <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000 1.41.996.996 0 001.41 0l1.06-1.06c.39-.39.39-1.03 0-1.41s-1.03-.39-1.41 0l-1.06 1.06z"> </path> </svg><svg id=icon-moon viewBox="0 0 24 24"> <path d="M9.37 5.51A7.35 7.35 0 009.1 7.5c0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27A7.014 7.014 0 0112 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49zM12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-5.5-5.38c0-1.56.64-3.03 1.75-4.08A8.965 8.965 0 0012 3z"> </path> </svg></button><button id=export-btn class=btn-success></button><button id=import-btn class=btn-primary></button><input type=file id=file-input accept=.json style=display:none></div> </header> <div class=content id=app-content></div> <footer class=footer>¬© PaoPaoGateWay</footer> </div> <div id=popup-overlay class="overlay hidden"></div> <div id=delete-popup class="popup hidden" style=display:flex;gap:10px><button id=confirm-delete class=btn-delete style=background:#dc3545;color:#fff;border:none>Confirm</button><button id=cancel-delete style="padding:8px 18px;border:1px solid #ccc;border-radius:6px;background:var(--color-background);color:var(--color-text)">Cancel</button> </div> <div id=subs-popup class="popup hidden" style=min-width:200px;padding:8px></div> <script>const svgs={star:'<svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>',check:'<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',close:'<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',up:'<svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>',down:'<svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>'},state={monitor:{enable:!1,url:"",retries:3,expectedStatus:"0",customStatus:""},subs:[],nodeGroups:[],rules:[],ui:{deleteConfirm:null,subsSelector:null,inputFocus:null,subSearch:"",sourceFilter:"sub"}};let currentLang="en",currentTheme="light";const texts={title:{zh:"PPsubÈÖçÁΩÆÁºñËæëÂô®",en:"PPsub Config Editor"},exportJson:{zh:"ÂØºÂá∫ÈÖçÁΩÆ",en:"Export JSON"},importJson:{zh:"ÂØºÂÖ•ÈÖçÁΩÆ",en:"Import JSON"},monitorTitle:{zh:"ÂÖ®Â±ÄÂÅ•Â∫∑ÁõëÊµã",en:"Global Health Monitor"},enableMonitor:{zh:"ÂºÄÂêØÂÖ®Â±ÄÂÅ•Â∫∑ÁõëÊµã",en:"Enable Global Health Monitor"},monitorUrl:{zh:"ÁõëÊµãURL",en:"Check URL"},monitorUrlDesc:{zh:"Ëã•‰∏∫Á©∫ÔºåÈªòËÆ§‰∏∫ https://www.youtube.com/generate_204",en:"Default: https://www.youtube.com/generate_204 if empty"},monitorRetries:{zh:"Â§±Ë¥•ÈáçËΩΩÈòàÂÄº (Ê¨°)",en:"Failure Threshold (Times)"},monitorRetriesDesc:{zh:"ÂΩìËøûÁª≠ÁõëÊµãÂ§±Ë¥•ËææÂà∞Ê≠§Ê¨°Êï∞ÂêéÔºåÈáçËΩΩÊâÄÊúâÈÖçÁΩÆ„ÄÇ",en:"Reload all configs after consecutive failures."},monitorStatus:{zh:"ÊúüÊúõËøîÂõûÁ†Å",en:"Expected Status"},monitorStatusAny:{zh:"‰ªªÊÑè (Any)",en:"Any"},monitorStatusCustom:{zh:"Ëá™ÂÆö‰πâ",en:"Custom"},monitorCustomPlaceholder:{zh:"ËæìÂÖ•Áä∂ÊÄÅÁ†Å (Â¶Ç 200) ÊàñËåÉÂõ¥ (Â¶Ç 200-399)",en:"Code (e.g. 200) or Range (e.g. 200-399)"},subsTitle:{zh:"ËÆ¢ÈòÖÊèê‰æõÂïÜ",en:"Subscription Providers"},addSub:{zh:"Ê∑ªÂä†ËÆ¢ÈòÖÊèê‰æõÂïÜ",en:"Add Provider"},nodeGroupsTitle:{zh:"ËäÇÁÇπÁªÑ",en:"Node Groups"},addNodeGroup:{zh:"Ê∑ªÂä†ËäÇÁÇπÁªÑ",en:"Add Node Group"},ruleSetsTitle:{zh:"ËßÑÂàôÁªÑ",en:"Rule Group"},addRuleSet:{zh:"Ê∑ªÂä†ËßÑÂàôÁªÑ",en:"Add Rule"},name:{zh:"ÂêçÁß∞",en:"Name"},url:{zh:"URL",en:"URL"},forcedDep:{zh:"Âº∫Âà∂‰æùËµñ",en:"Forced Dependency"},forcedDepDesc:{zh:"Â¶ÇÊûúÊúâÂº∫Âà∂‰æùËµñÁöÑÂ±ûÊÄßÔºå‰∏ãËΩΩÂ§±Ë¥•ÂàôËßÜ‰∏∫Â§ÑÁêÜÂ§±Ë¥•„ÄÇ",en:"If set, download failure treats as process failure."},deleteSub:{zh:"Âà†Èô§Ê≠§ËÆ¢ÈòÖÊèê‰æõÂïÜ",en:"Delete Provider"},deleteNodeGroup:{zh:"Âà†Èô§Ê≠§ËäÇÁÇπÁªÑ",en:"Delete Node Group"},deleteRuleSet:{zh:"Âà†Èô§Ê≠§ËßÑÂàôÁªÑ",en:"Delete Rule Set"},nodeGroupName:{zh:"ËäÇÁÇπÁªÑÂêçÁß∞",en:"Node Group Name"},nodeMode:{zh:"ËäÇÁÇπÊ®°Âºè",en:"Node Mode"},speedtestMode:{zh:"ÊµãÈÄüÊ®°Âºè",en:"Speedtest Mode"},manualMode:{zh:"ÊâãÂä®ÈÄâÊã©Ê®°Âºè",en:"Manual Selection Mode"},speedtestUrl:{zh:"ÊµãÈÄüURL",en:"Speedtest URL"},speedtestInterval:{zh:"ÊµãÈÄüÈó¥Èöî",en:"Speedtest Interval"},keywords:{zh:"ËäÇÁÇπÂÖ≥ÈîÆÂ≠ó",en:"Node Keywords"},excludeKeywords:{zh:"ÊéíÈô§ÂÖ≥ÈîÆÂ≠ó",en:"Exclude Keywords"},subsProvider:{zh:"ËÆ¢ÈòÖÊèê‰æõÂïÜ",en:"Subscription Providers"},addKeyword:{zh:"Ê∑ªÂä†ÂÖ≥ÈîÆÂ≠ó",en:"Add Keyword"},addExcludeKeyword:{zh:"Ê∑ªÂä†ÊéíÈô§ÂÖ≥ÈîÆÂ≠ó",en:"Add Exclude Keyword"},selectSub:{zh:"ÈÄâÊã©ËäÇÁÇπÊù•Ê∫ê",en:"Select Node Source"},all:{zh:"ÂÖ®ÈÉ®ËÆ¢ÈòÖ",en:"All Subscriptions"},ruleType:{zh:"ËßÑÂàôÁ±ªÂûã",en:"Rule Type"},manualRule:{zh:"ÊâãÂÜôËßÑÂàô",en:"Manual Rule"},urlDownload:{zh:"URL‰∏ãËΩΩ",en:"URL Download"},ruleSetType:{zh:"RULE-SETËÆ¢ÈòÖ",en:"RULE-SET Sub"},ruleUrl:{zh:"ËßÑÂàôURL",en:"Rule URL"},ruleContent:{zh:"ËßÑÂàôÂÜÖÂÆπ",en:"Rule Content"},moveUp:{zh:"‰∏äÁßª",en:"Move Up"},moveDown:{zh:"‰∏ãÁßª",en:"Move Down"},addRemark:{zh:"ÁÇπÂáªÊ∑ªÂä†Â§áÊ≥®...",en:"Click to add remark..."},topPriority:{zh:"ÊúÄ‰ºòÂÖà",en:"Top Priority"},highPriority:{zh:"Ê¨°‰ºòÂÖà",en:"High Priority"},lastPriority:{zh:"ÊúÄÂêé",en:"Last"},priority:{zh:"‰ºòÂÖàÁ∫ß",en:"Priority"},confirm:{zh:"Á°ÆËÆ§Âà†Èô§",en:"Confirm Delete"},cancel:{zh:"ÂèñÊ∂à",en:"Cancel"},emptyState:{zh:"ÊöÇÊó†Êï∞ÊçÆÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†",en:"No data yet, click button below to add"},importFailed:{zh:"ÂØºÂÖ•Â§±Ë¥•",en:"Import failed"},intervalPlaceholder:{zh:"ÁïôÁ©∫ÈªòËÆ§‰∏∫600Áßí",en:"Default 600s if empty"},behavior:{zh:"Ë°å‰∏∫(Behavior)",en:"Behavior"},ruleSetInterval:{zh:"Êõ¥Êñ∞Èó¥Èöî(Áßí)",en:"Interval (s)"},unnamedSub:{zh:"Êú™ÂëΩÂêçËÆ¢ÈòÖÊèê‰æõÂïÜ",en:"Unnamed Provider"},unnamedGroup:{zh:"Êú™ÂëΩÂêçËäÇÁÇπÁªÑ",en:"Unnamed Node Group"},inputKw:{zh:"ËæìÂÖ•ÂÖ≥ÈîÆÂ≠ó",en:"Enter keyword"},inputExKw:{zh:"ËæìÂÖ•ÊéíÈô§ÂÖ≥ÈîÆÂ≠ó",en:"Enter exclude keyword"},noSubWarn:{zh:"ËØ∑ÂÖàÊ∑ªÂä†ËÆ¢ÈòÖÊèê‰æõÂïÜ",en:"Add providers first"},subSearch:{zh:"ÊêúÁ¥¢ËÆ¢ÈòÖ...",en:"Search..."},noMatch:{zh:"Êó†ÂåπÈÖçÈ°π",en:"No matches"},copy:{zh:"Â§çÂà∂",en:"Copy"},copySuffix:{zh:"-Â§çÂà∂",en:"-copy"},ruleFormat:{zh:"Ê†ºÂºè(Format)",en:"Format"},downloadViaProxy:{zh:"ÈÄöËøáËäÇÁÇπÁªÑ‰∏ãËΩΩ",en:"Download via Node Group"},selectProxy:{zh:"ÈÄâÊã©ÊàñËæìÂÖ•ËäÇÁÇπÁªÑ",en:"Select or type Group"},customVal:{zh:"ÂõûËΩ¶ÂèØ‰ΩøÁî®Ëá™ÂÆö‰πâÂÄº",en:"Press Enter to use custom value"},nodeSource:{zh:"ËäÇÁÇπÊù•Ê∫ê",en:"Node Source"},filterSub:{zh:"ËÆ¢ÈòÖÊèê‰æõÂïÜ",en:"Subscription Providers"},filterGroup:{zh:"ËäÇÁÇπÁªÑ",en:"Node Groups"},filterBoth:{zh:"Ê∑∑Âêà(‰∏§ËÄÖ)",en:"Both"},keywordFilterHint:{zh:"ÂÖ≥ÈîÆÂ≠óÁ≠õÈÄâ‰ªÖÂØπÊù•Ëá™‚úàÔ∏èËÆ¢ÈòÖÊèê‰æõÂïÜÁöÑËäÇÁÇπÁîüÊïà",en:"Keyword filtering only affects nodes from ‚úàÔ∏èSubscription Providers"}},t=e=>texts[e][currentLang],keywordColors=["#ff6b35","#f7931e","#ffc107","#28a745","#17a2b8","#6610f2","#e83e8c"];function toggleLang(){currentLang="zh"===currentLang?"en":"zh",renderAll()}function toggleTheme(){setTheme("light"===currentTheme?"dark":"light")}function setTheme(e){currentTheme=e,document.documentElement.setAttribute("data-theme",e),"dark"===e?(document.getElementById("icon-sun").classList.remove("hidden"),document.getElementById("icon-moon").classList.add("hidden")):(document.getElementById("icon-sun").classList.add("hidden"),document.getElementById("icon-moon").classList.remove("hidden"))}function showNotification(e,t){const o=document.createElement("div");o.className="notification-banner "+("error"===t?"notification-error":"notification-success"),o.textContent=e,document.getElementById("notification-area").appendChild(o),setTimeout(()=>o.remove(),3e3)}function esc(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function escJs(e){return null==e?"":String(e).replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,"&quot;")}function renderAll(){document.getElementById("app-title").textContent=t("title"),document.getElementById("lang-btn").textContent="en"===currentLang?"‰∏≠Êñá":"English",document.getElementById("export-btn").textContent=t("exportJson"),document.getElementById("import-btn").textContent=t("importJson"),document.getElementById("confirm-delete").textContent=t("confirm"),document.getElementById("cancel-delete").textContent=t("cancel");if(document.getElementById("app-content").innerHTML=`${renderMonitor()}${renderSubs()}${renderNodeGroups()}${renderRules()}`,state.ui.inputFocus){const e=document.getElementById(state.ui.inputFocus);if(e&&(e.focus(),e.value)){const t=e.value.length;e.setSelectionRange(t,t)}}}function renderMonitor(){const e=state.monitor;return e.enable?`<section class="monitor-section"><div class="section-header"><h2 class="section-title">${t("monitorTitle")}</h2></div><div class="checkbox-row"><label class="checkbox-label"><input type="checkbox" checked onchange="updateMonitor('enable',this.checked)"><span class="checkbox-text">${t("enableMonitor")}</span></label></div><div class="item-row"><label class="label">${t("monitorUrl")}:</label><input type="text" value="${esc(e.url)}" oninput="updateMonitor('url',this.value)" placeholder="https://www.youtube.com/generate_204" id="mon-url"><span style="font-size:0.85em;color:var(--color-text-secondary);align-self:center;">${t("monitorUrlDesc")}</span></div><div class="item-row"><label class="label">${t("monitorStatus")}:</label><select onchange="updateMonitor('expectedStatus',this.value)" style="max-width:200px"><option value="0" ${"0"===e.expectedStatus?"selected":""}>${t("monitorStatusAny")}</option><option value="200" ${"200"===e.expectedStatus?"selected":""}>200</option><option value="204" ${"204"===e.expectedStatus?"selected":""}>204</option><option value="200-399" ${"200-399"===e.expectedStatus?"selected":""}>200-399</option><option value="custom" ${"custom"===e.expectedStatus?"selected":""}>${t("monitorStatusCustom")}</option></select>${"custom"===e.expectedStatus?`<input type="text" value="${esc(e.customStatus)}" oninput="updateMonitor('customStatus',this.value)" placeholder="${t("monitorCustomPlaceholder")}" id="mon-cust">`:""}</div><div class="item-row"><label class="label">${t("monitorRetries")}:</label><input type="number" value="${e.retries}" oninput="updateMonitor('retries',parseInt(this.value))" style="max-width:150px" min="1" id="mon-retry"><span style="font-size:0.85em;color:var(--color-text-secondary);align-self:center;">${t("monitorRetriesDesc")}</span></div></section>`:`<section class="monitor-section"><div class="section-header"><h2 class="section-title">${t("monitorTitle")}</h2></div><div class="checkbox-row"><label class="checkbox-label"><input type="checkbox" onchange="updateMonitor('enable',this.checked)"><span class="checkbox-text">${t("enableMonitor")}</span></label></div></section>`}function updateMonitor(e,t){state.monitor[e]=t,"enable"===e||"expectedStatus"===e?(state.ui.inputFocus=null,renderAll()):state.ui.inputFocus="mon-"+("expectedStatus"===e?"cust":"retries"===e?"retry":"url"===e?"url":"cust")}function renderSubs(){let e=0===state.subs.length?`<div style="text-align:center;color:gray;padding:20px;">${t("emptyState")}</div>`:state.subs.map((e,o)=>`<div class="item"><div class="item-header"><div style="display:flex;align-items:center;"><span class="item-number">#${o+1}</span><span class="item-name">${esc(e.name)||t("unnamedSub")}</span></div><div style="display:flex;gap:8px;"><button class="btn-copy" onclick="copySub(${o})">${t("copy")}</button><button class="btn-delete" onclick="askDelete('sub',${o},event)">${t("deleteSub")}</button></div></div><div class="item-row"><label class="label">${t("name")}:</label><input type="text" value="${esc(e.name)}" oninput="updateSub(${o},'name',this.value)" placeholder="e.g. My Provider" id="sub-name-${o}"></div><div class="item-row"><label class="label">${t("url")}:</label><input type="text" value="${esc(e.url)}" oninput="updateSub(${o},'url',this.value)" placeholder="Subscription URL" id="sub-url-${o}"></div><div class="checkbox-row"><label class="checkbox-label"><input type="checkbox" ${e.isforced?"checked":""} onchange="updateSub(${o},'isforced',this.checked)" class="checkbox"><span class="checkbox-text">${t("forcedDep")}</span></label><span class="checkbox-desc">${t("forcedDepDesc")}</span></div></div>`).join("");return`<section class="subs-section"><div class="section-header"><h2 class="section-title">${t("subsTitle")}</h2></div>${e}<div style="margin-top:15px;display:flex;justify-content:center;"><button class="btn-add-dashed" style="color:#42a5f5;border-color:#90caf9;" onclick="addSub()">+ ${t("addSub")}</button></div></section>`}function addSub(){state.subs.push({name:"",url:"",isforced:!1}),state.ui.inputFocus="sub-name-"+(state.subs.length-1),renderAll()}function updateSub(e,t,o){state.subs[e][t]=o,state.ui.inputFocus=`sub-${t}-${e}`}function copySub(e){const o={...state.subs[e]};o.name+=t("copySuffix"),state.subs.splice(e+1,0,o),renderAll()}function renderNodeGroups(){let e=0===state.nodeGroups.length?`<div style="text-align:center;color:gray;padding:20px;">${t("emptyState")}</div>`:state.nodeGroups.map((e,o)=>{const s=e.keywords.map((e,s)=>{if("object"==typeof e){const n=`nk-${o}-${s}`,l=state.ui.focusedKeywordInput===e.id?`<div style="position:absolute;top:100%;left:0;background:#333;color:#fff;padding:5px;border-radius:4px;z-index:10;font-size:0.8em;white-space:nowrap;">${"ËæìÂÖ•ÂÖ≥ÈîÆÂ≠ó"===t("inputKw")?"‰ª• exp# ÂºÄÂ§¥ÁöÑÂÖ≥ÈîÆÂ≠óÂèØÂåπÈÖçÊ≠£ÂàôÔºåÊØîÂ¶Ç exp#hk[1-3]":"Start with exp# for Regex matching, e.g. exp#hk[1-3]"}</div>`:"";return`<div style="position:relative;display:inline-block;"><input type="text" style="width:100px;border-radius:20px;padding:4px 10px;" value="${e.value}" id="${n}" onfocus="setKwFocus(${e.id},'${n}')" onblur="commitKeyword(${o},'keywords',${s})" onkeypress="if(event.key==='Enter')this.blur()"> ${l}</div>`}return`<span class="keyword-tag" style="background:${keywordColors[s%keywordColors.length]}">${esc(e)} <span class="tag-remove" onclick="removeKeyword(${o},'keywords',${s})">${svgs.close}</span></span>`}).join(""),n=e.exclude_keywords.map((e,s)=>{if("object"==typeof e){const n=`ek-${o}-${s}`,l=state.ui.focusedKeywordInput===e.id?`<div style="position:absolute;top:100%;left:0;background:#333;color:#fff;padding:5px;border-radius:4px;z-index:10;font-size:0.8em;white-space:nowrap;">${"ËæìÂÖ•ÂÖ≥ÈîÆÂ≠ó"===t("inputKw")?"‰ª• exp# ÂºÄÂ§¥ÁöÑÂÖ≥ÈîÆÂ≠óÂèØÂåπÈÖçÊ≠£ÂàôÔºåÊØîÂ¶Ç exp#hk[1-3]":"Start with exp# for Regex matching, e.g. exp#hk[1-3]"}</div>`:"";return`<div style="position:relative;display:inline-block;"><input type="text" style="width:100px;border-radius:20px;padding:4px 10px;" value="${e.value}" id="${n}" onfocus="setKwFocus(${e.id},'${n}')" onblur="commitKeyword(${o},'exclude_keywords',${s})" onkeypress="if(event.key==='Enter')this.blur()"> ${l}</div>`}return`<span class="keyword-tag" style="background:${keywordColors[(s+3)%keywordColors.length]}">${esc(e)} <span class="tag-remove" onclick="removeKeyword(${o},'exclude_keywords',${s})">${svgs.close}</span></span>`}).join(""),l=e.subs.map((e,s)=>`<span class="keyword-tag" style="background:${"all"===e?"#6c757d":"#17a2b8"}">${"all"===e?'<span style="width:14px;fill:white;margin-right:4px">'+svgs.star+"</span> "+t("all"):"‚úàÔ∏è "+esc(e)}<span class="tag-remove" onclick="removeGroupSub(${o},${s},'sub')">${svgs.close}</span></span>`).join(""),a=(e.include||[]).map((e,t)=>`<span class="keyword-tag" style="background:#6610f2">üì¶ ${esc(e)}<span class="tag-remove" onclick="removeGroupSub(${o},${t},'group')">${svgs.close}</span></span>`).join(""),r=e.include&&e.include.length>0&&(e.keywords&&e.keywords.length>0||e.exclude_keywords&&e.exclude_keywords.length>0)?`<div class="item-row" style="margin-top:-10px;margin-bottom:15px;"><label class="label"></label><div class="rule-hint" style="padding:8px 12px;font-size:0.8em;border:1px solid #ff9800;margin-top:0;max-width:600px;">${t("keywordFilterHint")}</div></div>`:"";return`<div class="item"><div class="item-header"><div style="display:flex;align-items:center;"><span class="item-number">#${o+1}</span><span class="item-name">${esc(e.name)||t("unnamedGroup")}</span></div><div style="display:flex;gap:8px;"><button class="btn-copy" onclick="copyNodeGroup(${o})">${t("copy")}</button><button class="btn-delete" onclick="askDelete('nodeGroup',${o},event)">${t("deleteNodeGroup")}</button></div></div><div class="item-row"><label class="label">${t("nodeGroupName")}:</label><input type="text" value="${esc(e.name)}" oninput="updateNodeGroup(${o},'name',this.value)" id="ng-name-${o}"></div><div class="item-row"><label class="label">${t("nodeMode")}:</label><div class="radio-group"><label class="radio-label"><input type="radio" name="mode-${o}" ${"speedtest"===e.mode?"checked":""} onchange="updateNodeGroup(${o},'mode','speedtest')"><span>${t("speedtestMode")}</span></label><label class="radio-label"><input type="radio" name="mode-${o}" ${"manual"===e.mode?"checked":""} onchange="updateNodeGroup(${o},'mode','manual')"><span>${t("manualMode")}</span></label></div></div>${"speedtest"===e.mode?`<div class="item-row"><label class="label">${t("speedtestUrl")}:</label><input type="text" value="${esc(e.speedtest_url||"")}" oninput="updateNodeGroup(${o},'speedtest_url',this.value)" id="ng-sp-${o}"></div><div class="item-row"><label class="label">${t("speedtestInterval")}:</label><input type="text" value="${esc(e.interval||"")}" oninput="updateNodeGroup(${o},'interval',this.value)" placeholder="${t("intervalPlaceholder")}" id="ng-int-${o}"></div>`:""}<div class="item-row"><label class="label">${t("keywords")}:</label><div class="keyword-container">${s}${e.keywords.some(e=>"object"==typeof e)?"":`<button class="btn-add-tag" onclick="addKeywordPlaceholder(${o},'keywords')">+ ${t("addKeyword")}</button>`}</div></div><div class="item-row"><label class="label">${t("excludeKeywords")}:</label><div class="keyword-container">${n}${e.exclude_keywords.some(e=>"object"==typeof e)?"":`<button class="btn-add-tag" onclick="addKeywordPlaceholder(${o},'exclude_keywords')">+ ${t("addExcludeKeyword")}</button>`}</div></div><div class="item-row"><label class="label">${t("nodeSource")}:</label><div class="keyword-container">${l}${a}<button class="btn-add-tag" onclick="openSubsSelector(${o},event)">+ ${t("selectSub")}</button></div></div>${r}</div>`}).join("");return`<section class="nodes-section"><div class="section-header"><h2 class="section-title">${t("nodeGroupsTitle")}</h2></div>${e}<div style="margin-top:15px;display:flex;justify-content:center;"><button class="btn-add-dashed" style="color:#ab47bc;border-color:#ce93d8;" onclick="addNodeGroup()">+ ${t("addNodeGroup")}</button></div></section>`}function addNodeGroup(){state.nodeGroups.push({name:"",keywords:[],exclude_keywords:[],subs:["all"],include:[],mode:"manual"}),state.ui.inputFocus="ng-name-"+(state.nodeGroups.length-1),renderAll()}function updateNodeGroup(e,t,o){state.nodeGroups[e][t]=o,"mode"===t?(state.ui.inputFocus=null,renderAll()):state.ui.inputFocus=`ng-${"speedtest_url"===t?"sp":"interval"===t?"int":"name"}-${e}`}function copyNodeGroup(e){const o=state.nodeGroups[e],s=JSON.parse(JSON.stringify(o));s.name+=t("copySuffix"),s.keywords=s.keywords.filter(e=>"object"!=typeof e),s.exclude_keywords=s.exclude_keywords.filter(e=>"object"!=typeof e),s.include=[...o.include||[]],state.nodeGroups.splice(e+1,0,s),renderAll()}function addKeywordPlaceholder(e,t){state.nodeGroups[e][t].push({value:"",isNew:!0,id:Date.now()}),renderAll(),setTimeout(()=>{const o=document.getElementById(`${"keywords"===t?"nk":"ek"}-${e}-${state.nodeGroups[e][t].length-1}`);o&&o.focus()},50)}function commitKeyword(e,t,o){const s=document.getElementById(`${"keywords"===t?"nk":"ek"}-${e}-${o}`),n=s?s.value.trim():"";state.ui.focusedKeywordInput=null,n?state.nodeGroups[e][t][o]=n:state.nodeGroups[e][t].splice(o,1),renderAll()}function removeKeyword(e,t,o){state.nodeGroups[e][t].splice(o,1),renderAll()}function removeGroupSub(e,t,o){const s=state.nodeGroups[e];"sub"===o?s.subs.splice(t,1):s.include.splice(t,1),0===s.subs.length&&0===s.include.length&&(s.subs=["all"]),renderAll()}function setKwFocus(e,t){state.ui.focusedKeywordInput=e,state.ui.inputFocus=t,renderAll()}function renderRules(){let e=0===state.rules.length?`<div style="text-align:center;color:gray;padding:20px;">${t("emptyState")}</div>`:state.rules.map((e,o)=>{const s=state.rules.length;let n="#17a2b8",l=`${t("priority")} ${e.priority}`;1===e.priority?(n="#ff6b35",l=t("topPriority")):2===e.priority?(n="#f7931e",l=t("highPriority")):e.priority===s&&(n="#6c757d",l=t("lastPriority"));const a="rule-set"===e.type,r="url"===e.type;return`<div class="item"><div class="item-header"><div style="display:flex;align-items:center;gap:12px;"><span class="item-number">#${o+1}</span><span class="priority-badge" style="background:${n}">${l}</span><input type="text" value="${esc(e.remark)}" oninput="updateRule(${o},'remark',this.value)" placeholder="${t("addRemark")}" style="border:none;border-bottom:1px dashed #ccc;padding:2px;background:transparent;width:150px;color:var(--color-text);" id="rule-rem-${o}"></div><div style="display:flex;gap:10px;"><button class="btn-nav" onclick="moveRule(${o},-1)" ${0===o?"disabled":""}>${svgs.up} ${t("moveUp")}</button><button class="btn-nav" onclick="moveRule(${o},1)" ${o===s-1?"disabled":""}>${svgs.down} ${t("moveDown")}</button><button class="btn-copy" onclick="copyRule(${o})">${t("copy")}</button><button class="btn-delete" onclick="askDelete('ruleSet',${o},event)">${t("deleteRuleSet")}</button></div></div><div class="item-row"><label class="label">${t("ruleType")}:</label><div class="radio-group"><label class="radio-label"><input type="radio" name="rtype-${o}" ${"manual"===e.type?"checked":""} onchange="updateRule(${o},'type','manual')"> ${t("manualRule")}</label><label class="radio-label"><input type="radio" name="rtype-${o}" ${r?"checked":""} onchange="updateRule(${o},'type','url')"> ${t("urlDownload")}</label><label class="radio-label"><input type="radio" name="rtype-${o}" ${a?"checked":""} onchange="updateRule(${o},'type','rule-set')"> ${t("ruleSetType")}</label></div></div>${a?`<div class="item-row"><label class="label">${t("name")}:</label><input type="text" value="${esc(e.name||"")}" oninput="updateRule(${o},'name',this.value)" placeholder="e.g. openai" id="rs-name-${o}"></div><div class="item-row"><label class="label">${t("ruleUrl")}:</label><input type="text" value="${esc(e.url)}" oninput="updateRule(${o},'url',this.value)" id="rs-url-${o}"></div><div class="item-row"><label class="label">${t("ruleFormat")}:</label><select onchange="updateRule(${o},'format',this.value)" style="cursor:pointer;"><option value="yaml" ${"yaml"===e.format?"selected":""}>yaml</option><option value="text" ${"text"===e.format?"selected":""}>text</option><option value="mrs" ${"mrs"===e.format?"selected":""}>mrs</option></select></div><div class="item-row"><label class="label">${t("behavior")}:</label><select onchange="updateRule(${o},'behavior',this.value)" style="cursor:pointer;"><option value="classical" ${"classical"===e.behavior?"selected":""}>classical</option><option value="domain" ${"domain"===e.behavior?"selected":""}>domain</option><option value="ipcidr" ${"ipcidr"===e.behavior?"selected":""}>ipcidr</option></select></div><div class="item-row"><label class="label">${t("ruleSetInterval")}:</label><input type="number" value="${e.interval||86400}" oninput="updateRule(${o},'interval',parseInt(this.value))" id="rs-int-${o}"></div><div class="checkbox-row"><label class="checkbox-label"><input type="checkbox" ${e.use_proxy?"checked":""} onchange="updateRule(${o},'use_proxy',this.checked)"><span class="checkbox-text">${t("downloadViaProxy")}</span></label></div>${e.use_proxy?`<div class="item-row"><label class="label">${t("selectProxy")}:</label><div class="dropdown-wrapper"><input type="text" value="${esc(e.proxy_group||"")}" oninput="handleProxyInput(${o},this.value)" onclick="showProxyDropdown(${o})" id="rs-proxy-${o}" placeholder="${t("selectProxy")}"><div id="proxy-dd-${o}" class="dropdown-list hidden">${renderProxyDropdownItems(o,e.proxy_group||"")}</div></div></div>`:""}<div class="rule-hint">RULE-SET Usage: RULE-SET,name,group</div>`:r?`<div class="item-row"><label class="label">${t("ruleUrl")}:</label><input type="text" value="${esc(e.url)}" oninput="updateRule(${o},'url',this.value)" id="rs-url-${o}"></div><div class="checkbox-row"><label class="checkbox-label"><input type="checkbox" ${e.isforced?"checked":""} onchange="updateRule(${o},'isforced',this.checked)"> <span class="checkbox-text">${t("forcedDep")}</span></label></div>`:`<div class="item-row" style="flex-direction:column;align-items:stretch;"><label class="label">${t("ruleContent")}:</label><textarea oninput="updateRule(${o},'content',this.value)" id="rs-cont-${o}">${esc(e.content)}</textarea><div class="rule-hint">Format: TYPE,MATCH,GROUP (e.g. GEOSITE,openai,AI-Nodes)</div></div>`}</div>`}).join("");return`<section class="rules-section"><div class="section-header"><h2 class="section-title">${t("ruleSetsTitle")}</h2></div>${e}<div style="margin-top:15px;display:flex;justify-content:center;"><button class="btn-add-dashed" style="color:#ff9800;border-color:#ffb74d;" onclick="addRuleSet()">+ ${t("addRuleSet")}</button></div></section>`}function addRuleSet(){state.rules.push({priority:state.rules.length+1,remark:"",name:"",type:"manual",url:"",content:"",behavior:"classical",interval:86400,format:"yaml",use_proxy:!1}),state.ui.inputFocus="rule-rem-"+(state.rules.length-1),renderAll()}function updateRule(e,t,o){state.rules[e][t]=o,"url"===t&&o&&(o.toLowerCase().endsWith(".mrs")?state.rules[e].format="mrs":o.toLowerCase().endsWith(".txt")?state.rules[e].format="text":(o.toLowerCase().endsWith(".yaml")||o.toLowerCase().endsWith(".yml"))&&(state.rules[e].format="yaml")),"use_proxy"!==t||o||delete state.rules[e].proxy_group,["type","behavior","format","use_proxy"].includes(t)?(state.ui.inputFocus=null,renderAll()):state.ui.inputFocus="remark"===t?`rule-rem-${e}`:"content"===t?`rs-cont-${e}`:`rs-${"interval"===t?"int":"name"===t?"name":"proxy_group"===t?"proxy":"url"}-${e}`}function moveRule(e,t){const o=e+t;if(o<0||o>=state.rules.length)return;const s=state.rules[e];state.rules[e]=state.rules[o],state.rules[o]=s,state.rules.forEach((e,t)=>e.priority=t+1),renderAll()}function copyRule(e){const o=JSON.parse(JSON.stringify(state.rules[e]));o.remark&&(o.remark+=t("copySuffix")),o.name&&(o.name+=t("copySuffix")),state.rules.splice(e+1,0,o),state.rules.forEach((e,t)=>e.priority=t+1),renderAll()}function renderProxyDropdownItems(e,o){const s=(o||"").toLowerCase();let n=state.nodeGroups.filter(e=>!o||e.name.toLowerCase().includes(s)).map(t=>`<div class="dropdown-item" onmousedown="setProxyGroup(${e},'${escJs(t.name)}')">${esc(t.name)}</div>`).join("");return n+=`<div class="dropdown-item" style="opacity:0.6;cursor:default;">${t("customVal")}</div>`,n}function handleProxyInput(e,t){state.rules[e].proxy_group=t;const o=document.getElementById(`proxy-dd-${e}`);o&&(o.innerHTML=renderProxyDropdownItems(e,t),o.classList.remove("hidden"))}function showProxyDropdown(e){document.querySelectorAll(".dropdown-list").forEach(e=>e.classList.add("hidden"));const t=document.getElementById(`proxy-dd-${e}`);t&&(t.innerHTML=renderProxyDropdownItems(e,state.rules[e].proxy_group),t.classList.remove("hidden"))}function setProxyGroup(e,t){state.rules[e].proxy_group=t;const o=document.getElementById(`rs-proxy-${e}`);o&&(o.value=t);const s=document.getElementById(`proxy-dd-${e}`);s&&s.classList.add("hidden")}function askDelete(e,t,o){state.ui.deleteConfirm={type:e,index:t};const s=document.getElementById("delete-popup"),n=document.getElementById("popup-overlay");s.style.top=o.clientY+"px",s.style.left=o.clientX+"px",s.classList.remove("hidden"),n.classList.remove("hidden")}function confirmDelete(){const{type:e,index:t}=state.ui.deleteConfirm;"sub"===e?state.subs.splice(t,1):"nodeGroup"===e?state.nodeGroups.splice(t,1):"ruleSet"===e&&(state.rules.splice(t,1),state.rules.forEach((e,t)=>e.priority=t+1)),closePopups(),renderAll()}function openSubsSelector(e,t){state.ui.inputFocus=null,state.ui.subsSelector=e,state.ui.subSearch="";const o=document.getElementById("subs-popup"),s=document.getElementById("popup-overlay");renderSubsPopup(e);window.innerHeight-t.clientY<350?(o.style.top="auto",o.style.bottom=window.innerHeight-t.clientY+10+"px"):(o.style.top=t.clientY+10+"px",o.style.bottom="auto"),o.style.left=t.clientX+"px",o.classList.remove("hidden"),s.classList.remove("hidden");const n=document.getElementById("sub-search-input");n&&n.focus()}function renderSubsPopup(e){const o=document.getElementById("subs-popup"),s=state.nodeGroups[e],n=state.ui.sourceFilter;let l=`<select id="src-filter" class="filter-select" onchange="updateSourceFilter(${e},this.value)"><option value="sub" ${"sub"===n?"selected":""}>${t("filterSub")}</option><option value="group" ${"group"===n?"selected":""}>${t("filterGroup")}</option><option value="both" ${"both"===n?"selected":""}>${t("filterBoth")}</option></select><input type="text" id="sub-search-input" value="${esc(state.ui.subSearch)}" placeholder="${t("subSearch")}" class="subs-search-input" oninput="updateSubSearch(this.value,${e})"><div style="margin:5px 0;border-bottom:1px solid var(--color-separator)"></div><div style="max-height:200px;overflow-y:auto;">`;const a=state.ui.subSearch.toLowerCase();let r=!1;("all".includes(a)||""===a)&&(l+=`<div class="subs-item" onclick="toggleSubSel(${e},'all','special')">${s.subs.includes("all")?'<span style="width:16px">'+svgs.check+"</span>":'<span style="width:16px"></span>'} <span style="width:16px;fill:orange;margin-right:4px;">${svgs.star}</span> ${t("all")}</div>`,r=!0);let i=[];"sub"!==n&&"both"!==n||(i=i.concat(state.subs.map(e=>({name:e.name,type:"sub"})))),"group"!==n&&"both"!==n||(i=i.concat(state.nodeGroups.map((e,t)=>({name:e.name,type:"group",index:t})).filter(t=>t.index!==e))),i.forEach(t=>{if(!t.name||!t.name.toLowerCase().includes(a))return;r=!0;const o="sub"===t.type?s.subs.includes(t.name):(s.include||[]).includes(t.name);t.type;l+=`<div class="subs-item" onclick="toggleSubSel(${e},'${escJs(t.name)}','${t.type}')">${o?'<span style="width:16px;fill:green">'+svgs.check+"</span>":'<span style="width:16px"></span>'} ${"group"===t.type?"üì¶":"‚úàÔ∏è"} ${esc(t.name)}</div>`}),!r&&a&&(l+=`<div class="subs-item" style="opacity:0.5;cursor:default;">${t("noMatch")}</div>`),0===i.length&&""===a&&"group"===n&&state.nodeGroups.length<=1&&(l+=`<div class="subs-item" style="opacity:0.5;cursor:default;">${t("emptyState")}</div>`),l+="</div>",o.innerHTML=l}function updateSourceFilter(e,t){state.ui.sourceFilter=t,renderSubsPopup(e);const o=document.getElementById("sub-search-input");o&&o.focus()}function updateSubSearch(e,t){state.ui.subSearch=e,renderSubsPopup(t);const o=document.getElementById("sub-search-input");o&&o.focus()}function toggleSubSel(e,t,o){const s=state.nodeGroups[e];if("special"===o&&"all"===t)s.subs=["all"],s.include=[];else{if(s.subs.includes("all")&&(s.subs=[]),"sub"===o){const e=s.subs.indexOf(t);e>-1?s.subs.splice(e,1):s.subs.push(t)}else{s.include||(s.include=[]);const e=s.include.indexOf(t);e>-1?s.include.splice(e,1):s.include.push(t)}0===s.subs.length&&0===s.include.length&&(s.subs=["all"])}renderAll(),renderSubsPopup(e);const n=document.getElementById("sub-search-input");if(n){n.focus();const e=n.value.length;n.setSelectionRange(e,e)}}function closePopups(){document.getElementById("delete-popup").classList.add("hidden"),document.getElementById("subs-popup").classList.add("hidden"),document.getElementById("popup-overlay").classList.add("hidden"),state.ui.deleteConfirm=null,state.ui.subsSelector=null}function handleExport(){const e=state.monitor,t="custom"===e.expectedStatus?e.customStatus:e.expectedStatus,o={version:"1.0",exported_at:(new Date).toISOString(),global_monitor:{enable:e.enable,url:e.url.trim()||"https://www.youtube.com/generate_204",retries:e.retries,expected_status:t},subs:state.subs.map(e=>{let t={name:e.name,url:e.url};return e.isforced&&(t.isforced=!0),t}),"node-groups":state.nodeGroups.map(e=>{let t={name:e.name,keywords:e.keywords.filter(e=>"string"==typeof e),exclude_keywords:e.exclude_keywords.filter(e=>"string"==typeof e),subs:e.subs.length?e.subs:e.include.length?[]:["all"],include:e.include};return"speedtest"===e.mode&&(e.speedtest_url&&(t.speedtest_url=e.speedtest_url.trim()),t.interval=e.interval?parseInt(e.interval):600),t}),rules:state.rules.map((e,t)=>{let o={priority:10*(t+1)};if(e.remark&&(o.remark=e.remark),"rule-set"===e.type)o.type="rule-set",o.name=e.name||`ruleset_${t}`,o.url=e.url,o.behavior=e.behavior||"classical",o.interval=e.interval||86400,o.format=e.format||"yaml",e.use_proxy&&e.proxy_group&&(o.proxy=e.proxy_group);else if("url"===e.type)o.url=e.url,e.isforced&&(o.isforced=!0);else{const t=(e.content||"").split("\n").map(e=>normalizeRule(e)).filter(e=>null!==e);o.fixrule=t}return o})},s=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),n=URL.createObjectURL(s),l=document.createElement("a");l.href=n,l.download="ppsub.json",l.click(),URL.revokeObjectURL(n)}function handleImport(e){const o=e.target.files[0];if(!o)return;const s=new FileReader;s.onload=e=>{try{const t=JSON.parse(e.target.result);if(t.global_monitor){state.monitor.enable=!!t.global_monitor.enable,state.monitor.url=t.global_monitor.url||"",state.monitor.retries=t.global_monitor.retries||3;const e=String(t.global_monitor.expected_status||"0");["0","200","204","200-399"].includes(e)?(state.monitor.expectedStatus=e,state.monitor.customStatus=""):(state.monitor.expectedStatus="custom",state.monitor.customStatus=e)}state.subs=(t.subs||[]).map(e=>({name:e.name||"",url:e.url||"",isforced:!!e.isforced})),state.nodeGroups=(t["node-groups"]||[]).map(e=>({name:e.name||"",keywords:e.keywords||[],exclude_keywords:e.exclude_keywords||[],subs:e.subs||[],include:e.include||[],mode:e.speedtest_url||e.interval?"speedtest":"manual",speedtest_url:e.speedtest_url||"",interval:e.interval?String(e.interval):""}));const o=t.rules||t["rule-sets"]||[];state.rules=o.map((e,t)=>{let o="manual";"rule-set"===e.type?o="rule-set":e.url&&(o="url");let s="";return"manual"===o&&(Array.isArray(e.fixrule)?s=e.fixrule.join("\n"):e.content&&(s=e.content)),{priority:t+1,remark:e.remark||"",name:e.name||"",type:o,url:e.url||"",content:s,isforced:!!e.isforced,behavior:e.behavior||"classical",interval:e.interval||86400,format:e.format||"yaml",use_proxy:!!e.proxy,proxy_group:e.proxy||""}}),renderAll(),showNotification("Loaded successfully","success")}catch(e){showNotification(t("importFailed")+": "+e,"error")}},s.readAsText(o),e.target.value=""}function normalizeRule(e){const t=(e=e.trim().replace(/^[-\s]+/,"")).indexOf("#");if(-1!==t&&(e=e.substring(0,t).trim()),!e)return null;const o=e.indexOf(",");if(-1===o)return"MATCH"===e.toUpperCase().replace(/[-\s_]/g,"")?"MATCH,auto":null;const s=e.substring(0,o).trim(),n=e.substring(o+1).trim(),l=s.toUpperCase().replace(/[-\s_]/g,""),a={DOMAIN:"DOMAIN",DOMAINSUFFIX:"DOMAIN-SUFFIX",DOMAINKEYWORD:"DOMAIN-KEYWORD",DOMAINWILDCARD:"DOMAIN-WILDCARD",DOMAINREGEX:"DOMAIN-REGEX",GEOSITE:"GEOSITE",IPCIDR:"IP-CIDR",IPCIDR6:"IP-CIDR6",IPSUFFIX:"IP-SUFFIX",IPASN:"IP-ASN",GEOIP:"GEOIP",SRCGEOIP:"SRC-GEOIP",SRCIPASN:"SRC-IP-ASN",SRCIPCIDR:"SRC-IP-CIDR",SRCIPSUFFIX:"SRC-IP-SUFFIX",SRCPORT:"SRC-PORT",DSTPORT:"DST-PORT",NETWORK:"NETWORK",RULESET:"RULE-SET",SUBRULE:"SUB-RULE",AND:"AND",OR:"OR",NOT:"NOT",MATCH:"MATCH"};return a[l]?`${a[l]},${n}`:null}function init(){const e=navigator.language||navigator.userLanguage;currentLang=e.startsWith("zh")?"zh":"en",window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?setTheme("dark"):setTheme("light"),document.getElementById("lang-btn").onclick=toggleLang,document.getElementById("theme-btn").onclick=toggleTheme,document.getElementById("export-btn").onclick=handleExport,document.getElementById("import-btn").onclick=()=>document.getElementById("file-input").click(),document.getElementById("file-input").onchange=handleImport,document.getElementById("popup-overlay").onclick=closePopups,document.getElementById("confirm-delete").onclick=confirmDelete,document.getElementById("cancel-delete").onclick=closePopups,document.addEventListener("click",e=>{document.querySelectorAll(".dropdown-list").forEach(t=>{if(!t.classList.contains("hidden")){t.parentElement.contains(e.target)||t.classList.add("hidden")}})}),renderAll()}init()</script> </body> </html>